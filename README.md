# Проектная работа

Сервер загружается по адресу http://localhost:8081

## Задание 2.2.
При анализе витрины dm.loan_holiday_info обнаружилось, что не хватает данных по колонке effective_from_date за '2023-03-15', а также отсутствуют данные в колонке product_name для ряда сделок.
После проанализировал данные в таблицах-источниках для витрины и сравнил их с актуальными выгрузками (csv-файлы):
1) В файле deal_info.csv данные есть только со значением колонки effective_from_date = '2023-03-15' (3500 строк), а в базе в таблице есть данные за '2023-01-01' и '2023-08-11' (6500 строк).
2) В файле product_info.csv 10000 строк и данные по колонке effective_from_date есть за '2023-01-01', '2023-03-15' и '2023-08-11', а в базе всего 3500 строк и данные там только за '2023-03-15'
3) Файла с данными по кредитным каникулам нет, сравнивать не с чем. Считаем что данные в таблице 'rd.loan_holiday' актуальны.

Исходя из проведенной аналитики делаем вывод что нужна частичная загрузка, т.к. при полной, потеряются данные.
Загрузку данных реализовал через airflow. Код DAG-а с комментариями во вложении - load_and_merge_data.py.

Так же переписал скрипт (loan_holiday_info_new.sql) для формирования витрины. Основные изменения:
1) Убрал CTE, чтобы улучшить читаемость запроса, так как он был слишко громоздким.
2) В условия объединения таблиц (LEFT JOIN) deal_info и product добавил условие deal_name = product_name, чтобы подтягивалось корректное наименование продукта для сделки, т.к. в таблицце product  имеются дублирующиеся строки по колонке product_rk, при этом имеющие различные значения product_name.

Данные итоговой витрины dm.loan_holiday_info во вложении. Экспортировал в csv-файл - dm_loan_holiday_info_new.csv

## Задание 2.3
1. 
    - Подготовить запрос, который определит корректное значение поля account_in_sum. Если значения полей account_in_sum одного дня и account_out_sum предыдущего дня отличаются, то корректным выбирается значение account_out_sum предыдущего дня.
    - Подготовить такой же запрос, только проблема теперь в том, что account_in_sum одного дня правильная, а account_out_sum предыдущего дня некорректна. Это означает, что если эти значения отличаются, то корректным значением для account_out_sum предыдущего дня выбирается значение account_in_sum текущего дня.
    - Подготовить запрос, который поправит данные в таблице rd.account_balance используя уже имеющийся запрос из п.1

    Скрипт с запросами project_task_2_part_3.sql лежит в директории /files/sql 

2.
    - Написать процедуру по аналогии с задание 2.2 для перезагрузки данных в витрину

    DAG для перегрузи данных в витрину load_and_merge_data_2.py лежит в директории /airflow/dags

3.
    В скрипт для выгрузки витрины добавил оператор ORDER BY, чтобы витрина проще читалась.
    Итоговый скрипт account_balance_turnover_prototype.sql лежит в директории /files/prototypes

4. 
    Экспортированные данные из перезагруженной витрины dm_account_balance_turnover_prototype.csv. Файл лежит в директории /files/data_from_db
